<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –§–æ—Ä–º</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #1a1a24;
      --bg-card-hover: #22222e;
      --border-color: #2a2a3a;
      --text-primary: #f0f0f5;
      --text-secondary: #8888a0;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --accent-glow: rgba(99, 102, 241, 0.3);
      --danger: #ef4444;
      --danger-hover: #f87171;
      --success: #10b981;
      --warning: #f59e0b;
      --radius: 12px;
      --radius-sm: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      background-image: 
        radial-gradient(ellipse at 20% 0%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(99, 102, 241, 0.08) 0%, transparent 50%);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 3rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid var(--border-color);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--accent), #a855f7);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 4px 20px var(--accent-glow);
    }

    h1 {
      font-weight: 600;
      font-size: 1.75rem;
      letter-spacing: -0.02em;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-sm);
      border: none;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      box-shadow: 0 4px 15px var(--accent-glow);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-card-hover);
      border-color: var(--accent);
    }

    .btn-danger {
      background: transparent;
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .btn-danger:hover {
      background: var(--danger);
      color: white;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    .main-layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 2rem;
    }

    .sidebar {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      padding: 1.5rem;
      height: fit-content;
      position: sticky;
      top: 2rem;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .sidebar h2 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .forms-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-height: 60vh;
      overflow-y: auto;
    }

    .form-item {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .form-item:hover {
      border-color: var(--accent);
      background: var(--bg-card-hover);
    }

    .form-item.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .form-item-title {
      font-weight: 500;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-item-status {
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 20px;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    .status-active {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }

    .status-draft {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    .form-item-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .editor-area {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      padding: 2rem;
      min-height: 600px;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: var(--text-secondary);
      text-align: center;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .form-editor-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .form-editor-title-group {
      flex: 1;
    }

    .form-editor-actions {
      display: flex;
      gap: 0.75rem;
    }

    .input-group {
      margin-bottom: 1.25rem;
    }

    .input-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .input-group input,
    .input-group select,
    .input-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      transition: border-color 0.2s ease;
    }

    .input-group input:focus,
    .input-group select:focus,
    .input-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .input-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .fields-section {
      margin-top: 2rem;
    }

    .fields-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .fields-header h3 {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .fields-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .field-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      padding: 1.25rem;
      transition: all 0.2s ease;
    }

    .field-card:hover {
      border-color: var(--accent);
    }

    .field-card--section {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
      border-color: rgba(99, 102, 241, 0.3);
    }

    .field-card--section:hover {
      border-color: rgba(168, 85, 247, 0.5);
    }

    .field-type-badge--section {
      background: linear-gradient(135deg, var(--accent), #a855f7);
      color: white;
    }

    .section-header-preview {
      padding: 0.5rem 0;
    }

    .field-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .field-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.3rem 0.75rem;
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent);
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      font-family: 'JetBrains Mono', monospace;
    }

    .field-card-actions {
      display: flex;
      gap: 0.5rem;
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .icon-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .icon-btn.danger:hover {
      border-color: var(--danger);
      color: var(--danger);
    }

    .field-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.75rem;
    }

    .field-info-item {
      font-size: 0.85rem;
    }

    .field-info-item span:first-child {
      color: var(--text-secondary);
    }

    .field-info-item span:last-child {
      color: var(--text-primary);
      font-weight: 500;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      padding: 2rem;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideIn 0.2s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h3 {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border-color);
    }

    .options-editor {
      margin-top: 0.5rem;
    }

    .option-item {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .option-item input {
      flex: 1;
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      padding: 1rem 1.5rem;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-weight: 500;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 2000;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      border-color: var(--success);
    }

    .toast.error {
      border-color: var(--danger);
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-icon">üìù</div>
        <h1>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –§–æ—Ä–º</h1>
      </div>
    </header>

    <div class="main-layout">
      <aside class="sidebar">
        <div class="sidebar-header">
          <h2>–§–æ—Ä–º—ã</h2>
          <button class="btn btn-primary btn-sm" onclick="showCreateFormModal()">
            + –ù–æ–≤–∞—è
          </button>
        </div>
        <div class="forms-list" id="formsList">
          <!-- Forms will be loaded here -->
        </div>
      </aside>

      <main class="editor-area" id="editorArea">
        <div class="empty-state">
          <div class="empty-state-icon">üìã</div>
          <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
          <p>–ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é —Ñ–æ—Ä–º—É</p>
        </div>
      </main>
    </div>
  </div>

  <!-- Create/Edit Form Modal -->
  <div class="modal-overlay" id="formModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="formModalTitle">–°–æ–∑–¥–∞—Ç—å —Ñ–æ—Ä–º—É</h3>
        <button class="icon-btn" onclick="closeModal('formModal')">‚úï</button>
      </div>
      <form id="formForm">
        <input type="hidden" id="formId">
        <div class="input-group">
          <label for="formTitle">–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã *</label>
          <input type="text" id="formTitle" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
        </div>
        <div class="input-group">
          <label for="formDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="formDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
        </div>
        <div class="input-group">
          <label for="formStatus">–°—Ç–∞—Ç—É—Å</label>
          <select id="formStatus">
            <option value="draft">–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
            <option value="active">–ê–∫—Ç–∏–≤–Ω–∞</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('formModal')">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create/Edit Field Modal -->
  <div class="modal-overlay" id="fieldModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="fieldModalTitle">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</h3>
        <button class="icon-btn" onclick="closeModal('fieldModal')">‚úï</button>
      </div>
      <form id="fieldForm">
        <input type="hidden" id="fieldId">
        <input type="hidden" id="fieldFormId">
        <div class="input-group">
          <label for="fieldType">–¢–∏–ø –ø–æ–ª—è *</label>
          <select id="fieldType" required onchange="toggleOptionsField()">
            <option value="section_header">üìå –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–∫—Ü–∏–∏</option>
            <option value="text">–¢–µ–∫—Å—Ç</option>
            <option value="textarea">–ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π —Ç–µ–∫—Å—Ç</option>
            <option value="email">Email</option>
            <option value="number">–ß–∏—Å–ª–æ</option>
            <option value="date">–î–∞—Ç–∞</option>
            <option value="checkbox">–ß–µ–∫–±–æ–∫—Å</option>
            <option value="choice">–í—ã–±–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞</option>
            <option value="select">–í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫</option>
            <option value="radio">–†–∞–¥–∏–æ –∫–Ω–æ–ø–∫–∏</option>
          </select>
        </div>
        <div class="input-row">
          <div class="input-group">
            <label for="fieldName">–ò–º—è –ø–æ–ª—è (ID) *</label>
            <input type="text" id="fieldName" required placeholder="field_name">
          </div>
          <div class="input-group">
            <label for="fieldLabel">–ú–µ—Ç–∫–∞ (Label)</label>
            <input type="text" id="fieldLabel" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
          </div>
        </div>
        <div class="input-group" id="fieldDescriptionGroup">
          <label for="fieldDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="fieldDescription" placeholder="–ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"></textarea>
        </div>
        <div class="input-group" id="optionsGroup" style="display: none;">
          <label>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞</label>
          <div class="options-editor" id="optionsEditor">
            <div class="option-item">
              <input type="text" class="option-input" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1">
              <button type="button" class="icon-btn danger" onclick="removeOption(this)">‚úï</button>
            </div>
          </div>
          <button type="button" class="btn btn-secondary btn-sm" onclick="addOption()" style="margin-top: 0.5rem;">
            + –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç
          </button>
        </div>
        <div class="input-group">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="fieldRequired">
            <label for="fieldRequired" style="margin: 0;">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('fieldModal')">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    const API_URL = '/api';
    let currentFormId = null;
    let forms = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadForms();
      setupFormHandlers();
    });

    // Setup form handlers
    function setupFormHandlers() {
      document.getElementById('formForm').addEventListener('submit', handleFormSubmit);
      document.getElementById('fieldForm').addEventListener('submit', handleFieldSubmit);
    }

    // Load all forms
    async function loadForms() {
      try {
        const response = await fetch(`${API_URL}/forms`);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || data.details || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
        
        forms = Array.isArray(data) ? data : [];
        renderFormsList();
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ä–º: ' + error.message, 'error');
        console.error(error);
        forms = [];
        renderFormsList();
      }
    }

    // Render forms list
    function renderFormsList() {
      const container = document.getElementById('formsList');
      
      if (!Array.isArray(forms) || forms.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="height: auto; padding: 2rem 0;">
            <p>–ù–µ—Ç —Ñ–æ—Ä–º</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = forms.map(form => `
        <div class="form-item ${currentFormId === form.id ? 'active' : ''}" 
             onclick="selectForm(${form.id})">
          <div class="form-item-title">
            ${form.title}
            <span class="form-item-status status-${form.status}">${form.status}</span>
          </div>
          <div class="form-item-meta">ID: ${form.id}</div>
        </div>
      `).join('');
    }

    // Select form for editing
    async function selectForm(formId) {
      currentFormId = formId;
      renderFormsList();
      
      try {
        const response = await fetch(`${API_URL}/forms/${formId}`);
        const form = await response.json();
        renderFormEditor(form);
        loadResponsesCount(formId);
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ä–º—ã', 'error');
        console.error(error);
      }
    }

    // Load responses count
    async function loadResponsesCount(formId) {
      try {
        const response = await fetch(`${API_URL}/forms/${formId}/responses/count`);
        const data = await response.json();
        const countEl = document.getElementById('responsesCount');
        if (countEl) {
          countEl.textContent = data.count || 0;
        }
      } catch (error) {
        console.error('Error loading responses count:', error);
        const countEl = document.getElementById('responsesCount');
        if (countEl) {
          countEl.textContent = '‚Äî';
        }
      }
    }

    // Export to Excel
    async function exportToExcel(formId) {
      try {
        showToast('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel —Ñ–∞–π–ª–∞...', 'success');
        
        const response = await fetch(`${API_URL}/forms/${formId}/export`);
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || error.details || 'Export failed');
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // Extract filename from Content-Disposition header or use default
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = 'responses.xlsx';
        if (contentDisposition) {
          const match = contentDisposition.match(/filename\*?=['"]?(?:UTF-8'')?([^;\n"']+)/i);
          if (match) {
            filename = decodeURIComponent(match[1]);
          }
        }
        
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
        
        showToast('Excel —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω!', 'success');
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message, 'error');
        console.error(error);
      }
    }

    // Render form editor
    function renderFormEditor(form) {
      const container = document.getElementById('editorArea');
      
      container.innerHTML = `
        <div class="form-editor-header">
          <div class="form-editor-title-group">
            <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">${form.title}</h2>
            <p style="color: var(--text-secondary);">
              ${form.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'} ‚Ä¢ 
              <span class="form-item-status status-${form.status}">${form.status}</span>
            </p>
          </div>
          <div class="form-editor-actions">
            <button class="btn btn-primary" onclick="exportToExcel(${form.id})" title="–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç–≤–µ—Ç–æ–≤ –≤ Excel">
              üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
            </button>
            <button class="btn btn-secondary" onclick="showEditFormModal(${form.id})">
              ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button class="btn btn-danger" onclick="deleteForm(${form.id})">
              üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
            </button>
          </div>
        </div>

        <div class="responses-info" id="responsesInfo" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-card); border-radius: var(--radius-sm); border: 1px solid var(--border-color);">
          <span style="color: var(--text-secondary);">üìù –û—Ç–≤–µ—Ç–æ–≤: </span>
          <span id="responsesCount">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>

        <div class="fields-section">
          <div class="fields-header">
            <h3>–ü–æ–ª—è —Ñ–æ—Ä–º—ã (${form.fields.length})</h3>
            <button class="btn btn-primary btn-sm" onclick="showAddFieldModal(${form.id})">
              + –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ
            </button>
          </div>
          <div class="fields-list" id="fieldsList">
            ${renderFieldsList(form.fields)}
          </div>
        </div>
      `;
    }

    // Render fields list
    function renderFieldsList(fields) {
      if (fields.length === 0) {
        return `
          <div class="empty-state" style="height: 150px;">
            <p>–ù–µ—Ç –ø–æ–ª–µ–π –≤ —Ñ–æ—Ä–º–µ</p>
          </div>
        `;
      }
      
      return fields.map(field => {
        const isSectionHeader = field.field_type === 'section_header';
        
        return `
          <div class="field-card ${isSectionHeader ? 'field-card--section' : ''}">
            <div class="field-card-header">
              <span class="field-type-badge ${isSectionHeader ? 'field-type-badge--section' : ''}">${getFieldTypeIcon(field.field_type)} ${isSectionHeader ? '–ó–ê–ì–û–õ–û–í–û–ö' : field.field_type}</span>
              <div class="field-card-actions">
                <button class="icon-btn" onclick="showEditFieldModal(${field.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                <button class="icon-btn danger" onclick="deleteField(${field.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
              </div>
            </div>
            ${isSectionHeader ? `
              <div class="section-header-preview">
                <h4 style="margin: 0; color: var(--text-primary);">${field.field_label || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h4>
              </div>
            ` : `
              <div class="field-info">
                <div class="field-info-item">
                  <span>–ò–º—è: </span>
                  <span>${field.field_name}</span>
                </div>
                <div class="field-info-item">
                  <span>–ú–µ—Ç–∫–∞: </span>
                  <span>${field.field_label || '‚Äî'}</span>
                </div>
                <div class="field-info-item">
                  <span>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ: </span>
                  <span>${field.is_required ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</span>
                </div>
                <div class="field-info-item">
                  <span>–ü–æ–∑–∏—Ü–∏—è: </span>
                  <span>${field.position}</span>
                </div>
                ${field.field_options ? `
                  <div class="field-info-item" style="grid-column: 1 / -1;">
                    <span>–í–∞—Ä–∏–∞–Ω—Ç—ã: </span>
                    <span>${JSON.stringify(field.field_options)}</span>
                  </div>
                ` : ''}
                ${field.description ? `
                  <div class="field-info-item" style="grid-column: 1 / -1;">
                    <span>–û–ø–∏—Å–∞–Ω–∏–µ: </span>
                    <span>${field.description}</span>
                  </div>
                ` : ''}
              </div>
            `}
          </div>
        `;
      }).join('');
    }

    // Get field type icon
    function getFieldTypeIcon(type) {
      const icons = {
        section_header: 'üìå',
        text: 'üìù',
        textarea: 'üìÑ',
        email: 'üìß',
        number: 'üî¢',
        date: 'üìÖ',
        checkbox: '‚òëÔ∏è',
        choice: 'üìã',
        select: 'üìã',
        radio: 'üîò'
      };
      return icons[type] || 'üìå';
    }

    // Modal functions
    function showModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function showCreateFormModal() {
      document.getElementById('formModalTitle').textContent = '–°–æ–∑–¥–∞—Ç—å —Ñ–æ—Ä–º—É';
      document.getElementById('formForm').reset();
      document.getElementById('formId').value = '';
      showModal('formModal');
    }

    async function showEditFormModal(formId) {
      try {
        const response = await fetch(`${API_URL}/forms/${formId}`);
        const form = await response.json();
        
        document.getElementById('formModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É';
        document.getElementById('formId').value = form.id;
        document.getElementById('formTitle').value = form.title;
        document.getElementById('formDescription').value = form.description || '';
        document.getElementById('formStatus').value = form.status;
        
        showModal('formModal');
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ä–º—ã', 'error');
      }
    }

    function showAddFieldModal(formId) {
      document.getElementById('fieldModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ';
      document.getElementById('fieldForm').reset();
      document.getElementById('fieldId').value = '';
      document.getElementById('fieldFormId').value = formId;
      document.getElementById('optionsGroup').style.display = 'none';
      resetOptionsEditor();
      showModal('fieldModal');
    }

    async function showEditFieldModal(fieldId) {
      try {
        // Find field in current form
        const response = await fetch(`${API_URL}/forms/${currentFormId}`);
        const form = await response.json();
        const field = form.fields.find(f => f.id === fieldId);
        
        if (!field) {
          showToast('–ü–æ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
          return;
        }
        
        document.getElementById('fieldModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–µ';
        document.getElementById('fieldId').value = field.id;
        document.getElementById('fieldFormId').value = field.form_id;
        document.getElementById('fieldType').value = field.field_type;
        document.getElementById('fieldName').value = field.field_name;
        document.getElementById('fieldLabel').value = field.field_label || '';
        document.getElementById('fieldDescription').value = field.description || '';
        document.getElementById('fieldRequired').checked = field.is_required;
        
        toggleOptionsField();
        
        if (field.field_options) {
          setOptionsFromArray(field.field_options);
        }
        
        showModal('fieldModal');
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—è', 'error');
      }
    }

    // Toggle options field visibility
    function toggleOptionsField() {
      const type = document.getElementById('fieldType').value;
      const optionsGroup = document.getElementById('optionsGroup');
      const requiredGroup = document.getElementById('fieldRequired').parentElement.parentElement;
      const fieldDescriptionGroup = document.getElementById('fieldDescriptionGroup');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–∏–ø–æ–≤ —Å –≤—ã–±–æ—Ä–æ–º
      const showOptions = ['choice', 'select', 'radio'].includes(type);
      optionsGroup.style.display = showOptions ? 'block' : 'none';
      
      // –î–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å–µ–∫—Ü–∏–π —Å–∫—Ä—ã–≤–∞–µ–º "–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ" –∏ "–æ–ø–∏—Å–∞–Ω–∏–µ"
      const isSectionHeader = type === 'section_header';
      requiredGroup.style.display = isSectionHeader ? 'none' : 'block';
      fieldDescriptionGroup.style.display = isSectionHeader ? 'none' : 'block';
      
      // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ–º –∏–º—è –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å–µ–∫—Ü–∏–∏
      if (isSectionHeader) {
        const fieldName = document.getElementById('fieldName');
        if (!fieldName.value) {
          fieldName.value = 'section_' + Date.now();
        }
        // –û—á–∏—â–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
        document.getElementById('fieldDescription').value = '';
      }
    }

    // Options editor functions
    function addOption() {
      const editor = document.getElementById('optionsEditor');
      const div = document.createElement('div');
      div.className = 'option-item';
      div.innerHTML = `
        <input type="text" class="option-input" placeholder="–í–∞—Ä–∏–∞–Ω—Ç">
        <button type="button" class="icon-btn danger" onclick="removeOption(this)">‚úï</button>
      `;
      editor.appendChild(div);
    }

    function removeOption(btn) {
      const items = document.querySelectorAll('.option-item');
      if (items.length > 1) {
        btn.parentElement.remove();
      }
    }

    function resetOptionsEditor() {
      const editor = document.getElementById('optionsEditor');
      editor.innerHTML = `
        <div class="option-item">
          <input type="text" class="option-input" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1">
          <button type="button" class="icon-btn danger" onclick="removeOption(this)">‚úï</button>
        </div>
      `;
    }

    function setOptionsFromArray(options) {
      const editor = document.getElementById('optionsEditor');
      editor.innerHTML = options.map((opt, i) => `
        <div class="option-item">
          <input type="text" class="option-input" value="${opt}" placeholder="–í–∞—Ä–∏–∞–Ω—Ç ${i + 1}">
          <button type="button" class="icon-btn danger" onclick="removeOption(this)">‚úï</button>
        </div>
      `).join('');
    }

    function getOptionsArray() {
      const inputs = document.querySelectorAll('.option-input');
      return Array.from(inputs)
        .map(input => input.value.trim())
        .filter(val => val !== '');
    }

    // Form submit handlers
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      const formId = document.getElementById('formId').value;
      const data = {
        title: document.getElementById('formTitle').value,
        description: document.getElementById('formDescription').value,
        status: document.getElementById('formStatus').value
      };
      
      try {
        if (formId) {
          await fetch(`${API_URL}/forms/${formId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          showToast('–§–æ—Ä–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
        } else {
          const response = await fetch(`${API_URL}/forms`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const newForm = await response.json();
          currentFormId = newForm.id;
          showToast('–§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
        }
        
        closeModal('formModal');
        await loadForms();
        if (currentFormId) {
          selectForm(currentFormId);
        }
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
      }
    }

    async function handleFieldSubmit(e) {
      e.preventDefault();
      
      const fieldId = document.getElementById('fieldId').value;
      const formId = document.getElementById('fieldFormId').value;
      const fieldType = document.getElementById('fieldType').value;
      
      const data = {
        field_type: fieldType,
        field_name: document.getElementById('fieldName').value,
        field_label: document.getElementById('fieldLabel').value,
        description: document.getElementById('fieldDescription').value,
        is_required: document.getElementById('fieldRequired').checked
      };
      
      if (['choice', 'select', 'radio'].includes(fieldType)) {
        data.field_options = getOptionsArray();
      }
      
      try {
        if (fieldId) {
          await fetch(`${API_URL}/fields/${fieldId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          showToast('–ü–æ–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        } else {
          await fetch(`${API_URL}/forms/${formId}/fields`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          showToast('–ü–æ–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ', 'success');
        }
        
        closeModal('fieldModal');
        selectForm(currentFormId);
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
      }
    }

    // Delete functions
    async function deleteForm(formId) {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ñ–æ—Ä–º—É? –í—Å–µ –ø–æ–ª—è –∏ –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
        return;
      }
      
      try {
        await fetch(`${API_URL}/forms/${formId}`, { method: 'DELETE' });
        showToast('–§–æ—Ä–º–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
        currentFormId = null;
        await loadForms();
        document.getElementById('editorArea').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <p>–ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é —Ñ–æ—Ä–º—É</p>
          </div>
        `;
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
      }
    }

    async function deleteField(fieldId) {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø–æ–ª–µ?')) {
        return;
      }
      
      try {
        await fetch(`${API_URL}/fields/${fieldId}`, { method: 'DELETE' });
        showToast('–ü–æ–ª–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
        selectForm(currentFormId);
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
      }
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Close modal on backdrop click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });
  </script>
</body>
</html>

